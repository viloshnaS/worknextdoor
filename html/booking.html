<!DOCTYPE html>
<html>

<head>

    <title>Work-next-door searching API</title>
    <link rel="stylesheet" href="css/normalize.css" type="text/css"/>
  <link rel="stylesheet" href="css/datepicker.css" type="text/css"/>
    <link rel="stylesheet" href="css/filter.css">    
    <link rel="stylesheet" href="css/booking.css">
    <link rel="stylesheet" href="https://code.jquery.com/mobile/1.5.0-alpha.1/jquery.mobile.structure-1.5.0-alpha.1.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="js/script.js"></script>
    <script src="js/booking.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script src="https://code.jquery.com/jquery-1.11.3.min.js"></script>
    <script src="https://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>
    <script type="text/javascript" src="js/jquery-1.7.1.min.js"></script>
  <script type="text/javascript" src="js/jquery-ui-1.8.18.custom.min.js"></script>
  
    

    
</head>                                                             

<body>
   <div id="back"><i class='material-icons'>arrow_back</i></div>
  <div id="homeBtn"><i class='material-icons'>home</i></div>
  <div id="heading">Choose your dates </div>
  <br>

<table width='100%'>
        <tr>
          <td><button class="rate" id="btn_hourly" value="1">Hourly</button></td>
          <td><button class="rate" id="btn_daily" value="2">Daily</button></td>
          <td><button class="rate" id="btn_monthly" value="3">Monthly</button></td>
          <td><input type="hidden" value="" id="space_rate"/>
        </tr>
      </table>

    <table>
      <tr >
              <td class="div_date_from"  style="display: none;">Date</td>
              <td class="div_date_from"  style="display: none;"><input class="datepicker" id="date_from" type ="text"></td>
      </tr>
      <tr>
              <td class="div_date_to"  style="display: none;">To</td>
              <td class="div_date_to"  style="display: none;"><input class="datepicker" id="date_to" type ="text"></td>
      <tr>
              <td class="div_month" style="display: none;">Number of Months</td>
              <td class="div_month" style="display: none;"><input id="month" type ="text" size="3"></td>
            
      </tr>


      <tr>
              <td class="div_time" style="display: none;" >Duration</td>
              <td class="div_time" style="display: none;" >
                  <select id="time_from">
                    <option value=""></option>
                    <option value="07">07.00</option>
                    <option value="08">08.00</option>
                    <option value="09">09.00</option>
                    <option value="10">10.00</option>
                    <option value="11">11.00</option>
                    <option value="12">12.00</option>
                    <option value="13">13.00</option>
                    <option value="14">14.00</option>
                    <option value="15">15.00</option>
                    <option value="16">16.00</option>
                    <option value="17">17.00</option>
                    <option value="18">18.00</option>
                    <option value="19">19.00</option>
                    <option value="20">20.00</option>
                    <option value="21">21.00</option>
                    <option value="22">22.00</option>
                    <option value="23">23.00</option>
                  </select>
              </td>
      </tr>
      <tr>
              <td class="div_time" style="display: none;" >To</td>
              <td class="div_time" style="display: none;">
                  <select id="time_to">
                    <option value=""></option>
                    <option value="07">07.00</option>
                    <option value="08">08.00</option>
                    <option value="09">09.00</option>
                    <option value="10">10.00</option>
                    <option value="11">11.00</option>
                    <option value="12">12.00</option>
                    <option value="13">13.00</option>
                    <option value="14">14.00</option>
                    <option value="15">15.00</option>
                    <option value="16">16.00</option>
                    <option value="17">17.00</option>
                    <option value="18">18.00</option>
                    <option value="19">19.00</option>
                    <option value="20">20.00</option>
                    <option value="21">21.00</option>
                    <option value="22">22.00</option>
                    <option value="23">23.00</option>
                  </select>
              </td>
            </tr>
            <tr style="border-bottom:0px">
              <td colspan='2' align="right"> <button id="submit_btn">Book</button></td>
            </tr>
        </table>  

  </div>
</body>

<script>
        $(document).ready(function(){

          $.urlParam = function(name){
                var results = new RegExp('[\?&]' + name + '=([^&#]*)').exec(window.location.href);
                return results[1] || 0;
            }

            var space_id = $.urlParam('space_id');

            $.when(getAvailableDates(space_id)).done(function(){
                var results = localStorage.getItem("booked_dates");

                var unavailableDates =[];
                var date_arr = JSON.parse(results);

                date_arr.forEach(function(dateObj) {
               
                    unavailableDates.push(dateObj);
                });

                $('.datepicker').datepicker({
                  dateFormat: 'yy-mm-dd',
                  inline: true,
                  showOtherMonths: true,
                  dayNamesMin: ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'],
                  minDate:new Date(),
                  beforeShowDay: function(date){
                    var string = jQuery.datepicker.formatDate('yy-mm-dd', date);
                    return [ unavailableDates.indexOf(string) == -1 ]
                }
                });

                 $('#date_from').change(function(){

                  var this_date = new Date($(this).val());
                
                      $('#date_to').datepicker('option', 'minDate', this_date);

                });


                


          });


            

          
           $(".rate").click(function(){
                
                var rate= this.value;


                //hourly - show time and hide to calendar
                if(rate==1){ 
                   $(".div_date_from").show();
                   $(".div_time").show();


                   $(".div_date_to").hide();
                   $(".div_month").hide();
                   $("#space_rate" ).val("1");


                }

                //daily - hide time and show to calendar
                else if(rate==2){ 

                  $(".div_date_from").show();
                  $(".div_date_to").show();

                  $(".div_time").hide();
                  $(".div_month").hide();
                
                  $( "#space_rate" ).val("2");


                }

                //monthly - hide time and to calendar - show number of months
                else if(rate ==3){

                  $(".div_date_from").show();
                  $(".div_month").show();
                  
                  
                  $(".div_time").hide();
                  $(".div_date_to").hide();

                  $( "#space_rate" ).val("3");

                }
            });

            $("#back").click(function(){

                history.back();

            });
           $("#home").click(function(){

                window.location="index.html";

            });


            $("#submit_btn").click(function(){
                var space_rate =$( "#space_rate" ).val();

                var date_time_from="";
                var date_time_to="";
                var duration="";
                var date_from =$( "#date_from" ).val();
                if(space_rate ==""){
                    
                    alert("Please select a rate");
                    return false;

                }
                if(date_from == ""){
                    
                    alert("Please select a date");
                    return false;

                }
                if(space_rate==1){
                  
              
                  var time_from =$( "#time_from" ).val();
                  var time_to =$("#time_to" ).val();
                  if(time_to =="" || time_from =="" ){
                    
                    alert("Please select the time");
                    return false;


                  }
                  if(Number(time_to) <= Number(time_from)){
                    
                    alert("Please input a valid time");
                    return false;

                  }
                  date_time_from = date_from+ " "+time_from+":00:00";
                  date_time_to = date_from+ " "+time_to+":00:00";
                }
                else if(space_rate==2){
                  
                  var date_to =$( "#date_to" ).val();
                     if(date_to ==""){
                  
                    alert("Please select the end date");
                    return false;


                  }

                  if(new Date(date_to) < new Date(date_from)){
                    
                    alert("The end date must be greater than start date.");
                    return false;


                  }
                  date_time_from = date_from+ " "+"07:00:00";
                  date_time_to = date_to+ " "+"23:00:00";
                 
                }

                 else if(space_rate==3){

                  duration =$( "#month" ).val();
                  if(duration ==""){
                    
                    alert("Please input a valid duration");
                    return false;
                  }
                  var dateFrom = new Date(date_from);
                  dateFrom.setMonth(dateFrom.getMonth()+ parseInt(duration));
                  var day = dateFrom.getDate();
                  var month= dateFrom.getMonth() + 1;
                  var year= dateFrom.getFullYear();
                  if(month < 10){
                    month = "0"+month;
                  }
                  date_time_from = date_from+ " "+"07:00:00";
                  date_time_to = year+"-"+month+"-"+day+ " "+"23:00:00";
                  

                }
                



                localStorage.setItem("date_from",date_time_from);
                localStorage.setItem("date_to",date_time_to);
                localStorage.setItem("space_rate",space_rate);
                localStorage.setItem("duration",duration);

                window.location="bookingSummary.html"

              });
        });
    </script>

</html>